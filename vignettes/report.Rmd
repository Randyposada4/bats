---
title: " Summer Research Project: Bats "
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{report}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
highlight: Tango
theme: Sandstone
---

***
#### *By Randy Posada*
```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(rotl)
library(devtools)
library(stringr)
library(datelife)
```

```{r out.width = "100%",out.height= "50%", fig.align = "center", echo=FALSE }
knitr::include_graphics("../images/Batphoto1.jpg")
```
*Fig.cap="[See attributions for link](#Attributions)*

***

# **My Report**

## *Overview*

  In this report I use the Open Tree of Life alongside Physcraper to create and access an updated phylogentic tree of all bats.

  There are over 1000 different species of bats. These extraordinary flying mammals use their hands to fly; granted their order name *chiroptera*, which translates in Greek to 'Hand Wings'. Each of their fingers are connected to one another through a thin layer of skin which allows these nocturnal mammals to take off into flight. Chiroptera are the only mammals with the capability of continued flight.

***

```{r get_names}

my_taxa <- c("chiroptera")
resolved_names <- rotl::tnrs_match_names(names = my_taxa)

resolved_names

```

  It is useful to know the class of an object since it makes manipulating objects much easier with different functions.When we create a class we create a data structure that will house all the objects that belong to a specific class. THis is done for  ease of access, organization, and clarity.
  
```{r Checking_class_of_an_object}
class(resolved_names)

```

  The class of the resolved_names object allows us to view the search string name, the unique name ,and the ott_id in respect to the open tree of life. The class of the  resolved_names object which includes trns_match_names, allows us to view two outputs : "match_names" and "data_frame"

  In the following chunk, We can subset to obtain certain columns and and if needed, manipulate the formula to extract a specific component from the row. Since there is no function that allows us to extract the values from a row of math_names, we need to use resolved names and indexing. Subsetting ultimately allows us to get values from all columns of one row.

```{r Obtaining_row_values}
resolved_names[1,]

```
This is part of the previous chunk.

Our goal is to obtain the ott_id for bats (chiroptera). In order to extract the information we need to subset using the column name 'unique_name' in the second part of the formula 'resolved_names'. This way, we can extract one specific value ( ) from the column we want using the column name.

ALSO EXPLAIN WHAT THE OTT ID IS
An OTT id is a unique numerical identifier assigned to a taxon in the Open Tree Taxonomy. Every raxon has a specific OTT id. These OTT ids allow us to interact with the Open Tree of Life.

IF YOU WANT TO KEEP THE FOLLOWING CHUNK, EXPLAIN WHAT THE UNIQUE NAME IDENTIFIER
MEANS FOR THE OPEN TREE OF LIFE.

```{r Obatining_The_Value_of_a_Specific_Column}
resolved_names[1,"unique_name"]
```

The next code gives all info from the current synthetic open tree:
```{r}
rotl::tol_about()
```
DESCRIBE THE OUTPUT OF THE PREVIOUS CODE

The previous code gave an output of the information from the Synthetic Opent Tree of Life (OTOL)

This function assigns our matched name 'chiroptera' to hiroptera_ott_id and will therefore extract the ott_id we wanted for chiroptera once we run it.
```{r}
chiroptera_ott_id <- rotl::tnrs_match_names("Chiroptera")$ott_id
chiroptera_ott_id
```

EXPLAIN HERE WHAT THE FOLLOWING SUBTREE IS

The following code will help us get a subtree:

```{r Obtaining_a_Subtree warning=FALSE}
chiroptera_subtree <- rotl::tol_subtree(ott_id = chiroptera_ott_id)

ape::Ntip(chiroptera_subtree)

ape::plot.phylo(chiroptera_subtree, cex = 0.1, type = "fan")
# or just plot(my_tree, cex = 0.1)
# because it ha sno branch lengths, it does not plot pretty. We have to get branch lengths for it.
# One way way to do this is to use datelife::datelife_search()
# Another way to do it is to make up teh branch lengths with ape::compute.brlen()
```

This will tell you if the taxon is monophyletic:

EXPLAIN HERE WHY IS IT RELEVANT THAT THE TAXON IS monophyletic?

```{r}
rotl::is_in_tree(chiroptera_ott_id)
```

WHY DO WE NEED THE NODE OF THE TAXON

```{r}
chiroptera_node_info <- rotl::tol_node_info(chiroptera_ott_id)
chiroptera_node_info
```

First task: Get and plot a tree of chiroptera families:
```{r}
chiroptera_families <- datelife::get_ott_children(ott_ids = chiroptera_ott_id, ott_rank = "family")
ls(chiroptera_families)
chiroptera_families
```

Using Chiroptera Families to create tree
```{r families}
chiroptera_families_subtree <- rotl::tol_induced_subtree(chiroptera_families$Chiroptera$ott_id)
```

Observing Tree Info

```{r tree_info}
chiroptera_families_subtree
```

Plotting Tree Of Chiroptera Families

```{r plot_subtree1}
ape::plot.phylo(chiroptera_families_subtree, cex = 0.8)
```

Figure out how to get the ott ids as a vector.

```{r}
chiroptera_families$Chiroptera$ott_id
```

```{r}
c(chiroptera_families$Chiroptera$ott_id)
```
```{r, inculde= FALSE}
# my_tree <- rotl::tol_induced_subtree(ott_ids = my_ott_ids)

# and plot the induced subtree
```

Task 2: Get an even smaller bat tree with 5 taxa that you like:
First get the scientific names of families, genera or species of bats.
Then run my_ott_ids <- rotl::tnrs_match_names to get the OTT ids

```{r}
my_ott_ids <- rotl::tnrs_match_names(c("Megadermatidae","Mormoopidae","Vespertilionidae","Mystacinidae","Furipteridae"))
```

You will need to extract the ott ids only, because now you have the whole table
```{r}
my_ott_ids
```

```{r}
my_tree <- rotl::tol_induced_subtree(my_ott_ids$ott_id)
```

```{r}
my_tree
```

```{r}
ape::plot.phylo(my_tree, cex = 1)
```

GET THE NODE AGES FOR YOUR 5 TAXA TREE:
GET THE DATELIFE RESULT AND DATELIFE TREE FOR THIS TREE OF 5 TAXA.

datelife::get_datelife_result

datelife::summarize_datelife_result(YOUR_DATELIFE_RESULT_OBJECT, summary_format = "phylo_all")

datelife::plot_phylo_all(trees = chiroptera_phylo_all)

***


```{r}
chiroptera_node_subtree <- rotl::tol_subtree(node_id = chiroptera_node_info$node_id, label = "name")
head(chiroptera_node_subtree$tip.label)
```
Datelife Functions

When you run the get datelife result function it will get node ages from published trees that contain at least two taxa from your search:

```{r }
chiroptera_dr <- datelife::get_datelife_result(chiroptera_node_subtree)
```

The datelife result object is not a tree but a list of tables with bthe node ages for each pair od taxa from your search.
For our 1800 species in the Chiroptera, we got the following trees with node ages:
```{r}
names(chiroptera_dr)
```

We have 7 studies in OpenTree with ages for the Chiroptera

To get the actual chronograms we need to run another function:
```{r }
chiroptera_phylo_all <-  datelife::summarize_datelife_result(chiroptera_dr, summary_format = "phylo_all")
```

Plotting Tree with ages
```{r }
datelife::plot_phylo_all(trees = chiroptera_phylo_all)
```

Summarizing node ages

```{r}
chiroptera_phylo_median <-  datelife::summarize_datelife_result(chiroptera_dr, summary_format = "phylo_median")

chiroptera_phylo_median
```

Plotting Chronogram
```{r }
ape::plot.phylo(chiroptera_phylo_median, cex = 1.2)
# Add the time axis:
ape::axisPhylo()
# And a little hack to add the axis name:
graphics::mtext("Time (myrs)", side = 1, line = 2, at = max(get("last_plot.phylo",envir = .PlotPhyloEnv)$xx) * 0.5)
```

# running python


# Reproducibility

Do you want to reproduce this repory yourself?

The following piece of code will render this report as pdf:

```{r include=FALSE, eval=FALSE}
rmarkdown::render("vignettes/report.Rmd", output_format="pdf_document")
```

# Attributions
[bat image](https://unsplash.com/photos/hNz4Qh9ECCc)
